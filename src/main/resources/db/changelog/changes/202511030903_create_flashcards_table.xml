<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!--
    ============================================================================
    Migration: Create flashcards table
    ============================================================================
    Purpose: Create flashcards table to store learning flashcards
    
    Affected Objects:
    - Table: flashcards
    - Foreign Keys: 
      * deck_id → decks(id) [CASCADE]
      * generation_id → ai_generations(id) [SET NULL]
    - Uses ENUM: flashcard_source_enum
    
    Key Features:
    - Each flashcard belongs to exactly one deck
    - Front and back text (max 500 chars each, trimmed)
    - Source tracking: manual, ai, or ai-edited
    - Optional link to AI generation session
    - Audit timestamps
    
    Delete Strategies:
    - CASCADE on deck_id: deleting deck removes all its flashcards
    - SET NULL on generation_id: flashcard survives if AI generation is deleted
    
    Business Rules:
    - Front and back cannot be empty after trimming
    - Maximum length: 500 characters each
    - Source changes from 'ai' to 'ai-edited' when user modifies AI flashcard
    ============================================================================
    -->

    <changeSet id="202511030903-1" author="10xcards-system">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="flashcards"/>
            </not>
        </preConditions>
        
        <comment>Create flashcards table for storing learning cards</comment>
        
        <sql><![CDATA[
            -- Create flashcards table
            -- Flashcards are the core learning unit: question (front) and answer (back)
            create table flashcards (
                -- Primary identifier: UUID for security
                id uuid primary key default gen_random_uuid(),
                
                -- Parent deck: each flashcard belongs to exactly one deck
                -- on delete cascade: deleting deck removes all its flashcards
                deck_id uuid not null,
                
                -- Flashcard content: question and answer
                -- application layer should trim whitespace before insert/update
                -- max length 500 chars to keep cards concise and focused
                front varchar(500) not null,
                back varchar(500) not null,
                
                -- Source tracking: how was this flashcard created?
                -- 'manual': user created manually
                -- 'ai': generated by AI and accepted without changes
                -- 'ai-edited': AI-generated but modified by user
                source flashcard_source_enum not null,
                
                -- Optional reference to AI generation session
                -- nullable because: 1) manual cards have no generation
                --                   2) generation may be deleted (statistics cleanup)
                -- on delete set null: flashcard survives even if generation is deleted
                generation_id uuid null,
                
                -- Audit fields: track creation and modification
                created_at timestamp with time zone not null default current_timestamp,
                updated_at timestamp with time zone not null default current_timestamp,
                
                -- Foreign key to decks table (mandatory, cascade delete)
                constraint fk_flashcards_deck_id 
                    foreign key (deck_id) 
                    references decks(id) 
                    on delete cascade,
                
                -- Foreign key to ai_generations table (optional, set null on delete)
                -- Note: this FK will be validated after ai_generations table is created
                constraint fk_flashcards_generation_id 
                    foreign key (generation_id) 
                    references ai_generations(id) 
                    on delete set null,
                
                -- Validation: front side cannot be empty after trimming
                constraint chk_flashcards_front_not_empty 
                    check (length(trim(front)) > 0),
                
                -- Validation: back side cannot be empty after trimming
                constraint chk_flashcards_back_not_empty 
                    check (length(trim(back)) > 0),
                
                -- Validation: front side maximum length
                constraint chk_flashcards_front_max_length 
                    check (length(front) <= 500),
                
                -- Validation: back side maximum length
                constraint chk_flashcards_back_max_length 
                    check (length(back) <= 500)
            );
            
            -- Add table comment for documentation
            comment on table flashcards is 
                'Learning flashcards with question (front) and answer (back)';
            
            -- Add column comments for clarity
            comment on column flashcards.id is 
                'Unique flashcard identifier (UUID)';
            comment on column flashcards.deck_id is 
                'Parent deck (FK to decks, cascade delete)';
            comment on column flashcards.front is 
                'Question or term (max 500 chars, trimmed by application)';
            comment on column flashcards.back is 
                'Answer or definition (max 500 chars, trimmed by application)';
            comment on column flashcards.source is 
                'Creation source: manual, ai, or ai-edited';
            comment on column flashcards.generation_id is 
                'Optional reference to AI generation session (FK to ai_generations)';
            comment on column flashcards.created_at is 
                'Timestamp when flashcard was created';
            comment on column flashcards.updated_at is 
                'Timestamp of last modification to flashcard content';
        ]]></sql>
        
        <rollback><![CDATA[
            -- Drop the flashcards table
            -- WARNING: This is a destructive operation that will delete all flashcards
            drop table if exists flashcards cascade;
        ]]></rollback>
    </changeSet>

</databaseChangeLog>

